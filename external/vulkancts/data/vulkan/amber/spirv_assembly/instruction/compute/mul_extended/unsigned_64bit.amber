#!amber
# Copyright 2022 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

DEVICE_FEATURE shaderInt64

# Based on the following GLSL shader with the bit size and signedness replaced.
#
##version 430
#
#layout(set = 0, binding = 0) buffer block0
#{
#    uvec2 inputs[];
#};
#
#layout(set = 0, binding = 1) buffer block1
#{
#    uvec2 outputs[];
#};
#
#void main()
#{
#    for (int i = 0; i < inputs.length(); i++)
#    {
#        umulExtended(inputs[i].x, inputs[i].y, outputs[i].x, outputs[i].y);
#    }
#}
SHADER compute compute_shader SPIRV-ASM TARGET_ENV spv1.0
; SPIR-V
; Version: 1.0
; Generator: Khronos Glslang Reference Front End; 10
; Bound: 50
; Schema: 0
               OpCapability Shader
               OpCapability Int64
          %1 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel Logical GLSL450
               OpEntryPoint GLCompute %main "main"
               OpExecutionMode %main LocalSize 1 1 1
               OpSource GLSL 430
               OpName %main "main"
               OpName %i "i"
               OpName %block0 "block0"
               OpMemberName %block0 0 "inputs"
               OpName %_ ""
               OpName %block1 "block1"
               OpMemberName %block1 0 "outputs"
               OpName %__0 ""
               OpName %ResType "ResType"
               OpDecorate %_runtimearr_v2uint64 ArrayStride 16
               OpMemberDecorate %block0 0 Offset 0
               OpDecorate %block0 BufferBlock
               OpDecorate %_ DescriptorSet 0
               OpDecorate %_ Binding 0
               OpDecorate %_runtimearr_v2uint64_0 ArrayStride 16
               OpMemberDecorate %block1 0 Offset 0
               OpDecorate %block1 BufferBlock
               OpDecorate %__0 DescriptorSet 0
               OpDecorate %__0 Binding 1
       %void = OpTypeVoid
          %3 = OpTypeFunction %void
        %int = OpTypeInt 32 1
%_ptr_Function_int = OpTypePointer Function %int
      %int_0 = OpConstant %int 0
       %uint = OpTypeInt 32 0
       %uint64 = OpTypeInt 64 0
 %v2uint64 = OpTypeVector %uint64 2
%_runtimearr_v2uint64 = OpTypeRuntimeArray %v2uint64
     %block0 = OpTypeStruct %_runtimearr_v2uint64
%_ptr_Uniform_block0 = OpTypePointer Uniform %block0
          %_ = OpVariable %_ptr_Uniform_block0 Uniform
       %bool = OpTypeBool
     %uint_0 = OpConstant %uint 0
%_ptr_Uniform_uint64 = OpTypePointer Uniform %uint64
     %uint_1 = OpConstant %uint 1
%_runtimearr_v2uint64_0 = OpTypeRuntimeArray %v2uint64
     %block1 = OpTypeStruct %_runtimearr_v2uint64_0
%_ptr_Uniform_block1 = OpTypePointer Uniform %block1
        %__0 = OpVariable %_ptr_Uniform_block1 Uniform
    %ResType = OpTypeStruct %uint64 %uint64
      %int_1 = OpConstant %int 1
       %main = OpFunction %void None %3
          %5 = OpLabel
          %i = OpVariable %_ptr_Function_int Function
               OpStore %i %int_0
               OpBranch %10
         %10 = OpLabel
               OpLoopMerge %12 %13 None
               OpBranch %14
         %14 = OpLabel
         %15 = OpLoad %int %i
         %22 = OpArrayLength %uint %_ 0
         %23 = OpBitcast %int %22
         %25 = OpSLessThan %bool %15 %23
               OpBranchConditional %25 %11 %12
         %11 = OpLabel
         %26 = OpLoad %int %i
         %29 = OpAccessChain %_ptr_Uniform_uint64 %_ %int_0 %26 %uint_0
         %30 = OpLoad %uint64 %29
         %31 = OpLoad %int %i
         %33 = OpAccessChain %_ptr_Uniform_uint64 %_ %int_0 %31 %uint_1
         %34 = OpLoad %uint64 %33
         %39 = OpLoad %int %i
         %40 = OpAccessChain %_ptr_Uniform_uint64 %__0 %int_0 %39 %uint_0
         %41 = OpLoad %int %i
         %42 = OpAccessChain %_ptr_Uniform_uint64 %__0 %int_0 %41 %uint_1
         %44 = OpUMulExtended %ResType %30 %34
         %45 = OpCompositeExtract %uint64 %44 0
               OpStore %42 %45
         %46 = OpCompositeExtract %uint64 %44 1
               OpStore %40 %46
               OpBranch %13
         %13 = OpLabel
         %47 = OpLoad %int %i
         %49 = OpIAdd %int %47 %int_1
               OpStore %i %49
               OpBranch %10
         %12 = OpLabel
               OpReturn
               OpFunctionEnd
END

BUFFER input DATA_TYPE vec2<uint64> DATA
10094288367415119808 1585044416077535558
1888758149242584402 13735935725321126321
15944051223964681736 1731946580463699378
14230337528211632464 17329268761692637369
5508706484046391021 9889059313707222819
10591992408819184703 15377370230438219904
6005665344539703407 16257832239706650257
355313408763532328 1280904805853334496
11405211680956869123 823051038796631050
4095929435154054010 5061337309657092962
2316441975305767128 5159918860500078605
8491474951551896353 3955559687522444900
2721057669544809267 9388196049200524131
17067810391095662475 15126590013504238451
3734157293172879053 11200502616118249132
14962400930642880638 10862760690373815346
14065099498423709147 10277388316157826761
5624450429005896998 13764686283483127833
12589082655240429546 14066115263437631987
18410197572295736664 10917780363314260877
17521599162635819557 3649803441919196859
15385811163204971407 14392877099205421598
11935502018751233554 17146067988496153848
13830697343515674162 18274429202917173726
11280369176771485221 10681916208201421336
17898416034547720769 17560089668057624977
8793970216262107881 17681530417044917593
7431034359200911091 6778926520675712578
5996313108013259362 14406559955132669934
5656733788212271227 17234480472733182679
17667575984470783395 13821598998243704477
7641659812818653057 167481054796026660
5013238065194306839 1358065335748893941
11299540603646371410 18023693357028342744
12689980231749630828 5179311415301396511
15726002655573876885 2798467024200474978
7277572188975415895 10855608033996957488
1492591637881730681 10218288704697954027
14252642771243793129 4123140648524334614
7789196198485669091 9075943778809166416
2574117355812736631 15309206106717527666
3674470655233383817 5800010337634120485
13208167359142417338 3105942311702332436
13450438530965130999 12085154638668978777
9848090507526100142 13023968381247910231
13002195050098702823 10338412060445406759
7994766691674000792 3850872962513579911
4020480539724509173 8704004968327816238
11742758694977385016 1701873357902620120
12968025479666304361 632029467618714131
8784031599896875534 4797818446121775516
1973832460769375992 9170149018032891246
3730004258462369508 14374440384501245421
12051735551210976831 4306295835576489947
15928194234311509309 16320387629392238220
12618067261357507298 16744747955873671751
5204875820039951670 11577651554673980571
11131994098105813205 7940355326084960035
5871348567459097940 4886642900176074880
1559335015169460699 2557344399587374974
17251672562959904445 16181871442717325508
4152452541889262718 4415679213469427219
12750358863276780773 10946738095287651944
4894664882300905785 11297118915389062283
16223787495147748246 7135250498641485382
11582594101915655812 10894819324918288843
7576280808124342035 14862228941201291263
15412491000270354745 9823474528985886680
2938971052182423559 4977741946844009247
7651145024934740158 17016143062141774335
13374597074993356357 15597464994273158074
16323465184486276103 4388038433914719407
5228978508079586634 4458732941677800367
1271636809190249588 11124628681314802591
15412357495164404494 7750122116953999890
10219754867553929823 12572945121094913430
18287391403148276595 14004925528427805990
6365103445149002821 2958886156715782504
2444878943809587327 17702409156699692162
462982434220535393 10605902611919764660
12980000794949824904 17009905983313476712
5223800341610013633 8590893444731791961
9087428225057297816 15161385906279990780
6831574038701029563 12268584502667126861
242021581535622491 1463701764264692971
4392111212166762680 9521989650499039985
8011924068051422185 760804195312997618
5982254671385889932 7412259631532296771
16482773045869450589 13616148511758920490
14136040722786307253 2212642776109219055
17301156833959806060 7803549334969109513
374143880623214877 9530644935337363359
16529617380314091321 15583241728968930482
16309565321233977039 13995230058057177576
2711595102399333973 18097871744055939419
9146141962961360941 4670159655128934978
330973046690336184 12831229675870452548
16672269577760031928 8538496358806954669
10054645438318101222 9243374992250196050
12357502882746024658 1541715316514891786
END

BUFFER output DATA_TYPE vec2<uint64> SIZE 100 FILL 0.0

BUFFER ref DATA_TYPE vec2<uint64> DATA
867356068209941624 14778067601375268480
1406419497934490561 8550080122851948466
1496971220815045394 8975966436525103504
13368285623230306824 14025039989914919632
2953145820469090788 16515106986971794791
8829579252445819953 2544171494810734464
5293026198509609600 9970982149051211999
24672248449415164 5706347886422481664
508874156013556422 6868593445030791198
1123823282039985263 2979931846761042612
647954597834384337 5962784446141657848
1820838185413757618 14810219385469239012
1384841832292533207 15103844094065409465
13995844967692079498 12633945062006457457
2267307355924582845 2681062505162604476
8810930536768458223 4406341419172532380
7836206144189668195 4867298759011029747
4196881322954231043 14467767125266929846
9599498262781802877 9886746835180688670
10896150168094484760 3182317357244322168
3466757747393446379 11140469801656372999
12004616546895054180 4193311705143693506
11093932255611774869 16666100670636677488
13701501924736433168 5211791742133068124
6532098990606307780 12805432242825702776
17038117362445446587 18292005118068512721
8429175969705805604 7334793217220794369
2730803641680786246 8690552178248529062
4683007687164658736 12357724908464104732
5284990544826778543 4334883988626701645
13237791425554788440 7147990644918640375
69379899278122708 484520771754803492
369078944717430796 11657405651751996163
11040401173325228246 4124580187884403504
3562978876468624963 9752340262302650900
2385716399504568839 1082545119799389706
4282732541144174474 5335448370421821776
826798063286973187 12645494354948882195
3185692311022251465 3354082078240949766
3832346049638326873 9336374506453071088
2136295325914998985 13095473220469023486
1155324088659138211 14939485269444792269
2223904971895476661 2905918657023341192
8811887287811060670 4159049216283265503
6953054635180120332 1175758087296290
7287033938405606691 8793616100437118001
1668957446991916115 7417298858434597672
1897043860585758421 945177290283192838
1083372116586346001 15925765090883434304
444315495852770457 12189775322856216779
2284641054968938331 6419130543375232648
981221278376300886 10330887923255834256
2906568423834648016 11654517704151029012
2813414573773747626 2579996159716954341
14092151064788896843 17446803705067641692
11453856308594839663 5523233056896393390
3266714081844607684 13814960474290786226
4791739304976741660 15323598086332739615
1555352189903467867 5835811774659824128
216176722146186094 6840796291434718922
15133529606644143152 17171500923204149428
993991042585730539 15307463268183120218
7566367188676059324 12513982188559205128
2997581091025157762 11692951559997963763
6275404881861491964 5828562854797926148
6840788246966719162 10269193241572439724
6104080993547936166 7160176606218995949
8207638820400969583 6599481207385800472
793063503703004068 3963213344162676185
7057775497576068947 15841260065026976578
11308760443368942840 4810988446940146978
3882961259612171768 18116755600320453833
1263888013632057361 17152139196831249302
766882614254684505 11236891719146172428
6475270227655684743 8185149483209310972
6965587888429948134 1515575589204338346
13883943620994753061 13431678730564307474
1020972394622048317 7214786734761013512
2346226912943432028 7719699129102873726
266190423022717192 4932738619466029108
11968973619583110818 3830010706662653760
2432793122298714147 2335344837003892761
7468960682989960953 16164617581216086432
4543552132838583090 12781954127172618303
19203790894930783 12464233401191415433
2267155512050348353 10817601149091671352
330438012212142311 3336305105825330754
2403785981367614292 8152682470811713700
12166476901364805159 10357316182941081666
1695584232267662675 12561877102523173115
7318930124815970288 12615217107922663372
193304166128220055 6146245761054632963
13963712094423909519 4334392027804314018
12373788995256522445 13253958077539656344
2660312312511245900 16889820913918207287
2315527500399388422 17176185736536104346
230219011096861236 6233832247807839456
7717140353545592706 357216377668558936
5038225598464785880 2909802612996591020
1032797516574167952 2800974998360648756
END

PIPELINE compute pipeline
  ATTACH compute_shader

  BIND BUFFER input AS storage DESCRIPTOR_SET 0 BINDING 0
  BIND BUFFER output AS storage DESCRIPTOR_SET 0 BINDING 1
END

RUN pipeline 1 1 1

EXPECT output EQ_BUFFER ref
