#!amber
# Copyright 2022 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

DEVICE_FEATURE shaderInt64

# Based on the following GLSL shader with the bit size and signedness replaced.
#
##version 430
#
#layout(set = 0, binding = 0) buffer block0
#{
#    uvec2 inputs[];
#};
#
#layout(set = 0, binding = 1) buffer block1
#{
#    uvec2 outputs[];
#};
#
#void main()
#{
#    for (int i = 0; i < inputs.length(); i++)
#    {
#        umulExtended(inputs[i].x, inputs[i].y, outputs[i].x, outputs[i].y);
#    }
#}
SHADER compute compute_shader SPIRV-ASM TARGET_ENV spv1.0
; SPIR-V
; Version: 1.0
; Generator: Khronos Glslang Reference Front End; 10
; Bound: 50
; Schema: 0
               OpCapability Shader
               OpCapability Int64
          %1 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel Logical GLSL450
               OpEntryPoint GLCompute %main "main"
               OpExecutionMode %main LocalSize 1 1 1
               OpSource GLSL 430
               OpName %main "main"
               OpName %i "i"
               OpName %block0 "block0"
               OpMemberName %block0 0 "inputs"
               OpName %_ ""
               OpName %block1 "block1"
               OpMemberName %block1 0 "outputs"
               OpName %__0 ""
               OpName %ResType "ResType"
               OpDecorate %_runtimearr_v2int64 ArrayStride 16
               OpMemberDecorate %block0 0 Offset 0
               OpDecorate %block0 BufferBlock
               OpDecorate %_ DescriptorSet 0
               OpDecorate %_ Binding 0
               OpDecorate %_runtimearr_v2int64_0 ArrayStride 16
               OpMemberDecorate %block1 0 Offset 0
               OpDecorate %block1 BufferBlock
               OpDecorate %__0 DescriptorSet 0
               OpDecorate %__0 Binding 1
       %void = OpTypeVoid
          %3 = OpTypeFunction %void
        %int = OpTypeInt 32 1
%_ptr_Function_int = OpTypePointer Function %int
      %int_0 = OpConstant %int 0
       %uint = OpTypeInt 32 0
       %int64 = OpTypeInt 64 1
 %v2int64 = OpTypeVector %int64 2
%_runtimearr_v2int64 = OpTypeRuntimeArray %v2int64
     %block0 = OpTypeStruct %_runtimearr_v2int64
%_ptr_Uniform_block0 = OpTypePointer Uniform %block0
          %_ = OpVariable %_ptr_Uniform_block0 Uniform
       %bool = OpTypeBool
     %uint_0 = OpConstant %uint 0
%_ptr_Uniform_int64 = OpTypePointer Uniform %int64
     %uint_1 = OpConstant %uint 1
%_runtimearr_v2int64_0 = OpTypeRuntimeArray %v2int64
     %block1 = OpTypeStruct %_runtimearr_v2int64_0
%_ptr_Uniform_block1 = OpTypePointer Uniform %block1
        %__0 = OpVariable %_ptr_Uniform_block1 Uniform
    %ResType = OpTypeStruct %int64 %int64
      %int_1 = OpConstant %int 1
       %main = OpFunction %void None %3
          %5 = OpLabel
          %i = OpVariable %_ptr_Function_int Function
               OpStore %i %int_0
               OpBranch %10
         %10 = OpLabel
               OpLoopMerge %12 %13 None
               OpBranch %14
         %14 = OpLabel
         %15 = OpLoad %int %i
         %22 = OpArrayLength %uint %_ 0
         %23 = OpBitcast %int %22
         %25 = OpSLessThan %bool %15 %23
               OpBranchConditional %25 %11 %12
         %11 = OpLabel
         %26 = OpLoad %int %i
         %29 = OpAccessChain %_ptr_Uniform_int64 %_ %int_0 %26 %uint_0
         %30 = OpLoad %int64 %29
         %31 = OpLoad %int %i
         %33 = OpAccessChain %_ptr_Uniform_int64 %_ %int_0 %31 %uint_1
         %34 = OpLoad %int64 %33
         %39 = OpLoad %int %i
         %40 = OpAccessChain %_ptr_Uniform_int64 %__0 %int_0 %39 %uint_0
         %41 = OpLoad %int %i
         %42 = OpAccessChain %_ptr_Uniform_int64 %__0 %int_0 %41 %uint_1
         %44 = OpSMulExtended %ResType %30 %34
         %45 = OpCompositeExtract %int64 %44 0
               OpStore %42 %45
         %46 = OpCompositeExtract %int64 %44 1
               OpStore %40 %46
               OpBranch %13
         %13 = OpLabel
         %47 = OpLoad %int %i
         %49 = OpIAdd %int %47 %int_1
               OpStore %i %49
               OpBranch %10
         %12 = OpLabel
               OpReturn
               OpFunctionEnd
END

BUFFER input DATA_TYPE vec2<int64> DATA
1697764898295313179 -1583815216942774417
-2246452991613323635 8449535288700877271
2627416114117125672 -3124152984911932855
-43236709873099735 5854596458334164933
1326191744341573901 7821745812728949170
8592853852586992073 8962340303954228345
3450233008175849062 3434398775107695252
-3457489862136449503 -8242049484325355856
8476309775168192332 325016089025950883
-4658061731586298919 -8636700033051074267
5460984615438580671 3444654861238435749
5231502016886101487 3906026667361622303
3824711396609006609 326968134426258840
-2611829131785124508 9122956541996048943
-2852218615961598190 -2625218596838806527
6389515874332832393 -6220860328261661659
-697615062979211803 6214354049728894508
-184495438367305326 -6887859517889343362
6587234633400457053 6109412609740539816
-3492590926084338331 6964585038076285479
-204111142063688267 8353380412273099113
-1237456780349845975 6670311352088939599
7387564251892977132 1066823458182476643
3990222572748067264 -9040852442983627533
-3833646326003576865 3721852972811450790
-6695242774736179440 -8103418607213822136
-2328879918742440140 7225363341964433291
-7542772690176292549 -426976033402051203
1617274125906413816 -7656388193350439422
8569965583708318638 8385696770313281848
1703368282708394806 -4288821867150061483
-268154532431338793 -4392415026205607651
1376140118615043366 8028175655715292757
789804692495955764 -6176368912034498428
1754561195400458949 -6648024157014454131
6953740701293409820 -7529273068025306996
1706774089671422948 -8802100611433058608
8432973703101825660 960618579237171048
3721317874630288440 -4472244691724083929
-4449810435855136010 9213564267976826988
4697734840921284265 -3400320814619238115
-8931677661882785580 1929937673544182591
4142895729976105834 214196578295932203
5476219201484961838 -7501172159253783554
4603643939439558499 4461895756534532238
-1022386484792474944 4238733490050515506
-6303846855748324450 -46877539132248855
-7048596888373414568 -5943161222445717295
2412780422431743511 8791175714421969674
-6324564171665737949 8648951073520141918
-2107881076773966289 1533565632616994436
-4353092475609153459 7059766930202303198
1638958496455493327 8323386020198446516
-1430986942716414687 9176326755468460291
-4599246887793665267 -7505258031068907000
397602220609075218 8754495651306845054
4266223548804666356 -3621244848036107150
963126893632761247 -3021502904315924572
-8136700769576331373 907122548413391755
-6876437201644182059 4047774924491901045
8422459303650285730 -2332449808823712165
6766778283886494632 3843213820868412637
5267170145407363405 -7406558741189627850
-8839009461440025767 4663626692825132093
-9035161479743184320 3622562546233149040
774129511061721995 -1449614165071558892
4418914969519337310 -4967381247098871242
198755165562704483 8325542368179910814
-8843753664145695349 -7144509066542594396
-7973650506145373754 -296406849925611532
1666413654961554570 -6160074733085504670
1984285944735974846 5131123222740165166
-4619032543213329882 -3165835901649814549
-2409100302499853405 -7726640975681101571
270385218610809896 4557484775140773164
6683790639213623203 2393997450535340975
-3055156318310326779 -6337770036195457325
1493785318301288415 -9189131934558846428
-5091923148371263260 -3993997588931776509
-2111174227404174029 3936874778829962068
9192395369785567563 2384429532603406947
2325480784279339846 -5322530634674281260
3283921804497305256 8643923201765552058
9205874698264908049 -297333111257791769
1017922243577204195 8693507873015348903
5105931140756185137 -8406479672369158862
1380693136954900411 5288222515028451556
8573910080780030569 875122851623918364
7920188104431955540 4129089782007822146
1445250113519123979 -1694134315801486087
186999331782705563 8886310864219830127
-2985256322091953876 8483587433804314276
3375085833274768875 -913470821975130597
-7499516031753708617 -31874520914662947
-5235745604665639494 4311904513569258794
7934031081038130715 8180088875172312000
5693625679296583596 -6464280221967264491
-10733339538926761 -4977777627264765306
-6590587127685028941 -7426802994960408225
2807847132181960923 -7448910087284167377
END

BUFFER output DATA_TYPE vec2<int64> SIZE 100 FILL 0.0

BUFFER ref DATA_TYPE vec2<int64> DATA
-145768048278163416 17061410397170738613
-1028988300114002110 11054313174839309675
-444980960473316196 909338473290019176
-13722393907651130 8182191462607133325
562328760117796721 3543451456882561034
4174833244354867073 17342250395234569217
642361382028563158 8174892294129090296
1544814760882151667 12776028976972395696
149345436868935662 15304165007357099364
2180887952388403016 4391238703868743517
1019757585813135483 12842155461797217051
1107750305780870931 14592297663442190065
67792925682229433 7201638291036759832
-1291696982903029221 15059538090738976092
405908886844901600 15089658311482400530
-2154758891900322901 9274389852205038029
-235013126135107123 2945447124082282844
68889049259187951 12636305815025567196
2181638893661056376 11905869041486618632
-1318630887420147924 16946845560454849635
-92429211855956241 17169073443800628285
-447462271754015974 12035760710113249959
427242163238015258 18363463965376570948
-1955630400179518914 13699247936124885312
-773484356812829606 2719796324539969946
2941134471417901932 14035369641159961728
-912193692582352044 7913758452310402364
174588163159632782 9741012625970710735
-671255505769640237 397137483130118640
3895816650886461500 8824053926038699024
-396028866096829959 13153328533747806446
63851159472376865 16139944649092141403
598907566287754541 3988227272362811806
-264443694226957438 14569856680580816
-632326505174783467 3322375238350964353
-2838257655392907413 1278524441691428688
-814409155254997862 15398755723818508608
439149108647499904 8650175859252446816
-902199545054267225 9965726826156104840
-2222539341752826045 2779780894818000840
-865941734612810874 7433700250311311909
-934451149684878386 14959917992327933996
48105729989631685 16400002358480219342
-2226846257963472707 1452086604421732260
1113528722245160465 18101451213082329322
-234926218716353378 6200458842198477184
16019565647100159 5994469016148697806
2270912825170905800 11812232300588780760
1149860190457407848 9516590528868803046
-2965338807949067730 7316171474836705498
-175238186428322033 10686979897718987324
-1665975208449778027 14950581212070679750
739517184310338900 4261769027801736332
-711843982694449939 909001895699857507
1871253512465550834 3889392748958321256
188694920760188130 14567351590051753692
-837494139071258229 6592610435724202664
-157756333296977184 9991554290685668060
-400123984388915905 10564586481134822865
-1508898804224654718 10379520407206572633
-1064955610276111834 3846532138484518294
1409797616287690938 4285230152095008776
-2114823349091702567 2864626277947369022
-2234640449164972083 12060901831988895797
-1774320576298004805 8919989781212462080
-60833993270083104 1841825438323266524
-1189935484788276204 3301009097545906644
89703881897795948 7608656209836327194
3425226586506881369 16637457050396421900
128122590061988693 14960879754860653240
-556479377053180398 11156377127145581268
551946492611809435 16125473259773117476
792719788259791974 3683803325084523234
1009080683151575126 5736182954816495639
66801843854825641 12337861797692645088
867414741932377836 5825418944520259949
1049663728878666993 6402452514290195487
-744119955094989792 17254737587896572252
1102477960140693113 17671799961633538732
-450563445580016405 12720935151533528508
1188210716617579985 271015046486054401
-670982514053175987 15210844955179159032
1538806402108324711 4135834641442233872
-148384525472198959 17052049625857919063
479722329495967122 3057820272302278933
-2326855415338992695 10602730000913211026
395810366534883398 6130862794095518348
406750622737425888 9680708028969834108
1772842277364204764 6700366800448290216
-132730621861789082 1010340495187676339
90082791140948390 7795600848420798261
-1372908027540673267 13795600718127515696
-167132065042963254 16558981015188550089
12958573049466781 393889326407646203
-1223849315328970508 4260564545974530692
3518294563091429608 4926886786656433472
-1995213449207922426 6484502489347050780
2896347301681938 1783742857161842058
2653421764993115249 6426170027497247341
-1133826150722767792 17396045847600942901
END

PIPELINE compute pipeline
  ATTACH compute_shader

  BIND BUFFER input AS storage DESCRIPTOR_SET 0 BINDING 0
  BIND BUFFER output AS storage DESCRIPTOR_SET 0 BINDING 1
END

RUN pipeline 1 1 1

EXPECT output EQ_BUFFER ref
